cmake_minimum_required(VERSION 3.19)
cmake_policy(SET CMP0074 NEW)
project(OCRAImpl LANGUAGES CXX)

include(FetchContent)
#[[
# Fetch MESA3D_DEV for Windows
if (WIN32)
  FetchContent_Declare(
    MESA3D_DEV
    URL https://github.com/pal1000/mesa-dist-win/releases/download/22.0.1/mesa3d-22.0.1-development-pack-msvc.7z
  )
  if (NOT MESA3D_DEV_POPULATED)
    FetchContent_Populate(MESA3D_DEV)
    message(STATUS "Fetched MESA3D_DEV to ${mesa3d_dev_SOURCE_DIR}")
    find_library(OPENGL_opengl_LIBRARY
      NAMES opengl32
      PATHS ${mesa3d_dev_SOURCE_DIR}/lib/x64/
    )
    set(OPENGL_INCLUDE_DIR ${mesa3d_dev_SOURCE_DIR}/include)
    find_library(OPENGL_egl_LIBRARY
      NAMES libEGL
      PATHS ${mesa3d_dev_SOURCE_DIR}/lib/x64/
    )
    set(OPENGL_EGL_INCLUDE_DIR ${mesa3d_dev_SOURCE_DIR}/include)
  endif (NOT MESA3D_DEV_POPULATED)
endif (WIN32)
# Fetch MESA3D_DEV for Windows

# Fetch MESA3D_REL for Windows
if (WIN32)
  FetchContent_Declare(
    MESA3D_REL
    URL https://github.com/pal1000/mesa-dist-win/releases/download/22.0.1/mesa3d-22.0.1-release-msvc.7z
  )
  if (NOT MESA3D_REL_POPULATED)
    FetchContent_Populate(MESA3D_REL)
    message(STATUS "Fetched MESA3D_REL to ${mesa3d_rel_SOURCE_DIR}")
  endif (NOT MESA3D_REL_POPULATED)
endif (WIN32)
# Fetch MESA3D_REL for Windows

message(STATUS ${OPENGL_opengl_LIBRARY})
message(STATUS ${OPENGL_egl_LIBRARY})

find_package(OpenGL REQUIRED)


#PowerVR SDK for Windows
if (WIN32)
  FetchContent_Declare(
    PVR_SDK
    GIT_REPOSITORY  https://github.com/powervr-graphics/Native_SDK.git
    GIT_TAG         R21.2-v5.8
  )
  if (NOT PVR_SDK_POPULATED)
    FetchContent_MakeAvailable(PVR_SDK)
  endif (NOT PVR_SDK_POPULATED)
endif (WIN32)
#PowerVR SDK for Windows
]]

#[[
#EGL for Windows
if (WIN32)
  FetchContent_Declare(
    EGL
    GIT_REPOSITORY  https://github.com/McNopper/EGL.git
    SOURCE_SUBDIR   EGL
  )
  if (NOT EGL_POPULATED)
    option(EGL_NO_GLEW "Do not use GLEW" ON)
    FetchContent_MakeAvailable(EGL)
    set_target_properties(egl PROPERTIES FOLDER "3rdparty")
    add_library(OpenGL::EGL ALIAS egl)
  endif (NOT EGL_POPULATED)
endif (WIN32)
#EGL for Windows

]]

# Fetch GLEW
FetchContent_Declare(
  GLEW
  GIT_REPOSITORY  https://github.com/Perlmint/glew-cmake.git
  GIT_TAG         glew-cmake-2.2.0
)
FetchContent_GetProperties(GLEW)
if (NOT GLEW_POPULATED)
  FetchContent_Populate(GLEW)
  message(STATUS "Fetched GLEW to ${glew_SOURCE_DIR}")
  option(ONLY_LIBS "Do not build executables" ON)
  option(glew-cmake_BUILD_STATIC "Build the static glew library" ON)
  option(glew-cmake_BUILD_SHARED "Build the shared glew library" OFF)
  add_subdirectory(${glew_SOURCE_DIR} ${glew_BINARY_DIR})
  add_library(GLEW::glew_s ALIAS libglew_static)
  add_library(GLEW::GLEW ALIAS libglew_static)
  set_target_properties(libglew_static PROPERTIES FOLDER "3rdparty")
  set(GLEW_FOUND 1)
  set(GLEW_INCLUDE_DIR ${glew_SOURCE_DIR}/include)
  set(GLEW_LIBRARIES GLEW::glew GLEW::glew_s)
endif (NOT GLEW_POPULATED)
# Fetch GLEW

set(OCRA_IMPL_HEADER_FILES
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Buffer.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Device.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Memory.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Instance.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/ObjectPool.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/PhysicalDevice.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Surface.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/WeakHandle.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Command/Buffer.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Command/ExecutionState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Command/Pool.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Common/Blend.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Common/Compare.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Common/IndexType.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Common/Logic.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Common/Stencil.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Common/VertexType.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Image/Format.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Image/Image.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Image/View.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Queue/Fence.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Queue/Queue.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Queue/Semaphore.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/ColorBlendState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/DepthStencilState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/MultisampleState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/Pipeline.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/RasterizationState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/ShaderPipelineState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/TessellationState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/VertexInputState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Pipeline/ViewPortState.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Shader/Stage.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/Error.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/Instance.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/OpenGL.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/PhysicalDevice.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/Surface.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/SwapChain.hpp
  ${CMAKE_CURRENT_SOURCE_DIR}/include/GL/Win32/Window.hpp
)
set(OCRA_IMPL_SOURCE_FILES
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Buffer.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Device.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/FrameBuffer.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Instance.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Memory.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/PhysicalDevice.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/QueryPool.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/SwapChain.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Queue/Fence.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Queue/Queue.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Queue/Semaphore.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/Buffer.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/Draw.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/MemoryBarrier.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/Pool.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/Query.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/Scissor.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Command/ViewPort.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Image/Image.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Image/View.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Pipeline/Graphics.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Pipeline/Pipeline.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Shader/Stage.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Shader/Module.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/Error.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/Instance.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/OpenGL.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/PhysicalDevice.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/Surface.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/SwapChain.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/src/Win32/Window.cpp
)

add_library(OCRAImpl ${OCRA_IMPL_SOURCE_FILES} ${OCRA_IMPL_HEADER_FILES})
target_include_directories(OCRAImpl PRIVATE
  "${CMAKE_CURRENT_SOURCE_DIR}/include"
  "${CMAKE_CURRENT_SOURCE_DIR}/../../include"
)
target_link_libraries(OCRAImpl PUBLIC GLEW::GLEW)

set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -DDEBUG")

if (MSVC_IDE)
  set(CMAKE_DEBUG_POSTFIX "d")
  # Macro to preserve source files hierarchy in the IDE
  macro(GroupSources curdir)
    file(GLOB children RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}/${curdir} ${CMAKE_CURRENT_SOURCE_DIR}/${curdir}/*)
  
    foreach(child ${children})
      if (IS_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${curdir}/${child})
        GroupSources(${curdir}/${child})
      else()
        string(REPLACE "/" "\\" groupname ${curdir})
        string(REPLACE "src" "Sources" groupname ${groupname})
        string(REPLACE "include" "Includes" groupname ${groupname})
        #string(REPLACE "shaders" "Shaders" groupname ${groupname})
        source_group(${groupname} FILES ${CMAKE_CURRENT_SOURCE_DIR}/${curdir}/${child})
      endif ()
    endforeach()
  endmacro()
  
  # Run macro
  GroupSources(src)
  GroupSources(include)
  GroupSources(../../include)
endif ()